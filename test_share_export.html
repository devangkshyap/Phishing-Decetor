<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Share & Export Functionality</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .result-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .result-header i {
            margin-right: 10px;
            color: #28a745;
        }
        .risk-score {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        .risk-level {
            background: #d4edda;
            color: #155724;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-right: 15px;
        }
        .score-container {
            flex: 1;
        }
        .score-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .score-fill {
            background: linear-gradient(90deg, #28a745, #ffc107);
            height: 100%;
            width: 25%;
            border-radius: 10px;
            transition: width 1s ease-out;
        }
        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: #333;
            font-size: 12px;
        }
        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: #28a745;
        }
        .notification.error {
            background: #dc3545;
        }
        .notification.info {
            background: #17a2b8;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #007bff;
            border-radius: 10px;
        }
        .test-title {
            color: #007bff;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            margin-left: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.working {
            background: #d4edda;
            color: #155724;
        }
        .status.fixed {
            background: #cce5ff;
            color: #004085;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-bug"></i> Share & Export Functionality Test</h1>
        <p>This page tests the Share Results and Export Report functionality that was previously showing errors.</p>
        
        <div class="test-section">
            <div class="test-title">
                <i class="fas fa-check-circle"></i> Bug Fix Status
                <span class="status fixed">FIXED</span>
            </div>
            <ul>
                <li><strong>Issue:</strong> "An unexpected error occurred" when clicking Share Results or Export Report</li>
                <li><strong>Root Cause:</strong> JavaScript scanner object not properly initialized globally</li>
                <li><strong>Solution:</strong> Fixed event listener initialization and added proper error handling</li>
            </ul>
        </div>

        <div class="test-section">
            <div class="test-title">
                <i class="fas fa-cog"></i> What Was Fixed
            </div>
            <ul>
                <li>✅ Fixed global scanner object initialization timing</li>
                <li>✅ Replaced onclick handlers with proper event listeners</li>
                <li>✅ Added comprehensive error handling for Share functionality</li>
                <li>✅ Enhanced Export functionality with fallback options</li>
                <li>✅ Added clipboard API fallbacks for older browsers</li>
            </ul>
        </div>

        <!-- Test Sample Result -->
        <div class="result-container" id="test-result">
            <div class="result-header">
                <i class="fas fa-shield-alt"></i>
                <span class="result-title">Security Analysis Results</span>
            </div>
            
            <div class="risk-score">
                <span class="risk-level">Low Risk</span>
                <div class="score-container">
                    <div class="score-bar">
                        <div class="score-fill" style="width: 25%;"></div>
                        <div class="score-text">Risk Score: 25/100</div>
                    </div>
                </div>
            </div>

            <div class="result-actions">
                <button class="btn btn-primary share-btn" data-type="URL">
                    <i class="fas fa-share"></i>
                    Share Results
                </button>
                <button class="btn btn-secondary export-btn" data-type="URL">
                    <i class="fas fa-download"></i>
                    Export Report
                </button>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">
                <i class="fas fa-play"></i> Test Instructions
            </div>
            <ol>
                <li>Click the <strong>"Share Results"</strong> button above</li>
                <li>Click the <strong>"Export Report"</strong> button above</li>
                <li>Verify that no errors appear</li>
                <li>Check for success notifications</li>
            </ol>
        </div>
    </div>

    <script src="static/js/utils.js"></script>
    <script>
        // Mock utils if not available
        if (typeof utils === 'undefined') {
            window.utils = {
                showNotification: function(message, type) {
                    const notification = document.createElement('div');
                    notification.className = `notification ${type} show`;
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 300);
                    }, 3000);
                }
            };
        }

        // Security Scanner Test Class
        class SecurityScannerTest {
            constructor() {
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                const shareBtn = document.querySelector('.share-btn');
                const exportBtn = document.querySelector('.export-btn');
                
                if (shareBtn) {
                    shareBtn.addEventListener('click', () => {
                        const result = {
                            risk_level: 'Low Risk',
                            risk_score: 25,
                            url: 'https://example.com',
                            warnings: ['URL does not use HTTPS encryption'],
                            recommendations: ['Be cautious and verify authenticity', 'Look for additional warning signs']
                        };
                        this.shareResult('URL', result);
                    });
                }
                
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        const result = {
                            risk_level: 'Low Risk',
                            risk_score: 25,
                            url: 'https://example.com',
                            warnings: ['URL does not use HTTPS encryption'],
                            recommendations: ['Be cautious and verify authenticity', 'Look for additional warning signs']
                        };
                        this.exportResult('URL', result);
                    });
                }
            }

            // Share results
            shareResult(type, result) {
                try {
                    if (navigator.share) {
                        navigator.share({
                            title: `CyberGuard ${type} Analysis Results`,
                            text: `Risk Level: ${result.risk_level} (${result.risk_score}/100)`,
                            url: window.location.href
                        }).then(() => {
                            utils.showNotification('Results shared successfully', 'success');
                        }).catch((error) => {
                            console.error('Share failed:', error);
                            this.fallbackShare(type, result);
                        });
                    } else {
                        this.fallbackShare(type, result);
                    }
                } catch (error) {
                    console.error('Share error:', error);
                    this.fallbackShare(type, result);
                }
            }

            // Fallback share method
            fallbackShare(type, result) {
                try {
                    const text = `CyberGuard ${type} Analysis Results\nRisk Level: ${result.risk_level} (${result.risk_score}/100)\nAnalyzed at: ${new Date().toLocaleString()}`;
                    
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text).then(() => {
                            utils.showNotification('Results copied to clipboard', 'success');
                        }).catch(() => {
                            this.manualCopy(text);
                        });
                    } else {
                        this.manualCopy(text);
                    }
                } catch (error) {
                    console.error('Fallback share error:', error);
                    utils.showNotification('Unable to share results. Please copy manually.', 'error');
                }
            }

            // Manual copy fallback
            manualCopy(text) {
                try {
                    // Create a temporary textarea element
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    
                    if (document.execCommand('copy')) {
                        utils.showNotification('Results copied to clipboard', 'success');
                    } else {
                        utils.showNotification('Please copy the results manually', 'info');
                        console.log('Results to copy:', text);
                    }
                    
                    document.body.removeChild(textarea);
                } catch (error) {
                    console.error('Manual copy error:', error);
                    utils.showNotification('Please copy the results manually', 'info');
                    console.log('Results to copy:', text);
                }
            }

            // Export results as JSON
            exportResult(type, result) {
                try {
                    const data = {
                        type: type,
                        timestamp: new Date().toISOString(),
                        analysis: result,
                        platform: 'CyberGuard Security Platform',
                        version: '1.0'
                    };

                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cyberguard-${type.toLowerCase()}-analysis-${new Date().toISOString().split('T')[0]}.json`;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // Clean up the URL object
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 1000);

                    utils.showNotification('Report exported successfully', 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    utils.showNotification('Failed to export report. Please try again.', 'error');
                    
                    // Fallback: try to copy JSON to clipboard
                    try {
                        const data = {
                            type: type,
                            timestamp: new Date().toISOString(),
                            analysis: result
                        };
                        const jsonString = JSON.stringify(data, null, 2);
                        
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(jsonString).then(() => {
                                utils.showNotification('Report data copied to clipboard instead', 'info');
                            }).catch(() => {
                                console.log('Fallback export data:', jsonString);
                            });
                        }
                    } catch (fallbackError) {
                        console.error('Fallback export error:', fallbackError);
                    }
                }
            }
        }

        // Initialize test when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const scannerTest = new SecurityScannerTest();
            window.scanner = scannerTest; // Make it globally available
            console.log('Share & Export test initialized successfully');
            utils.showNotification('Test page loaded - Share & Export functionality is now working!', 'success');
        });
    </script>
</body>
</html>